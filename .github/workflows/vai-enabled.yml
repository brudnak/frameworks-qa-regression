name: Run Rancher Test Suite
on:
  workflow_dispatch:  # Manual trigger for privacy
jobs:
  run-test-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v3
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Clone Rancher Tests Repository
        run: |
          git clone https://github.com/rancher/tests.git
          cd tests
      
      - name: Create config file
        run: |
          # Create the cattle config file
          cat > cattle-config.yaml <<EOF
          rancher:
            host: "${{ secrets.RANCHER_HOST }}"
            adminToken: "${{ secrets.RANCHER_ADMIN_TOKEN }}"
            cleanup: true
            insecure: true
            clusterName: "${{ secrets.CLUSTER_NAME }}"
          EOF
      
      - name: Run Webhook Tests
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any,stress ./validation/charts -run TestWebhookTestSuite
      
      - name: Wait between tests
        run: sleep 30
      
      - name: Run Token Tests
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation -run TestTokenTestSuite
      
      - name: Wait between tests
        run: sleep 30
      
      - name: Run ConfigMap Tests
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation/configmaps -run TestConfigMapTestSuite
      
      - name: Wait between tests
        run: sleep 30
      
      - name: Run Schema Changes Tests
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation/schemas -run TestSchemaChangesTestSuite
      
      - name: Wait between tests
        run: sleep 30
      
      - name: Run Node Annotations Tests
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation/nodeannotations -run TestNodeAnnotationsTestSuite