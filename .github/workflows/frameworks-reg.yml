name: Run Rancher Test Suite
on:
  workflow_dispatch:  # Manual trigger for privacy
jobs:
  run-test-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v3
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Clone Rancher Tests Repository
        run: |
          git clone https://github.com/rancher/tests.git
          cd tests
      
      - name: Create config file
        run: |
          # Create the cattle config file
          cat > cattle-config.yaml <<EOF
          rancher:
            host: "${{ secrets.RANCHER_HOST }}"
            adminToken: "${{ secrets.RANCHER_ADMIN_TOKEN }}"
            cleanup: true
            insecure: true
            clusterName: "${{ secrets.CLUSTER_NAME }}"
          EOF
      
      
      - name: Run Token Tests
        id: token-test
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation/token -run TestTokenTestSuite
      
      - name: Wait between tests
        run: sleep 30
      
      - name: Run ConfigMap Tests
        id: configmap-test
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation/configmaps -run TestConfigMapTestSuite
      
      - name: Wait between tests
        run: sleep 30
      
      - name: Run Schema Changes Tests
        id: schema-test
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation/schemas -run TestSchemaChangesTestSuite
      
      - name: Wait between tests
        run: sleep 30
      
      - name: Run Node Annotations Tests
        id: node-test
        continue-on-error: true
        env:
          CATTLE_TEST_CONFIG: ${{ github.workspace }}/cattle-config.yaml
        run: |
          cd tests
          go test -v -tags=validation,infra.any,cluster.any ./validation/nodeannotations -run TestNodeAnnotationsTestSuite
      
      - name: Check test results
        if: always()
        run: |
          echo "Webhook Tests: ${{ steps.webhook-test.outcome }}"
          echo "Token Tests: ${{ steps.token-test.outcome }}"
          echo "ConfigMap Tests: ${{ steps.configmap-test.outcome }}"
          echo "Schema Tests: ${{ steps.schema-test.outcome }}"
          echo "Node Annotations Tests: ${{ steps.node-test.outcome }}"
          
          if [[ "${{ steps.webhook-test.outcome }}" == "failure" ]] || \
             [[ "${{ steps.token-test.outcome }}" == "failure" ]] || \
             [[ "${{ steps.configmap-test.outcome }}" == "failure" ]] || \
             [[ "${{ steps.schema-test.outcome }}" == "failure" ]] || \
             [[ "${{ steps.node-test.outcome }}" == "failure" ]]; then
            echo "One or more tests failed"
            exit 1
          fi